---
name: E2E Tests
on:
  pull_request:
    types: [labeled]
jobs:   
  e2e-test:
    if: contains(github.event.pull_request.labels.*.name, 'state:needs_test')
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Log in to gcr.io
        shell: bash
        env:
          GCR_PULL_SECRET: ${{ secrets.GCR_PULL_SECRET }}
        run: |
          echo "$GCR_PULL_SECRET" | docker login -u _json_key --password-stdin gcr.io

      - name: Pull awx_cypress_base image
        run: |
          docker pull gcr.io/ansible-tower-engineering/awx_cypress_base:stable
      
      - name: Checkout tower-qa
        uses: actions/checkout@v2
        with:
          path: tower-qa

      - name: Build cypress
        run: |
          cd tower-qa/ui-tests/awx-pf-tests
          docker build -t awx-pf-tests .

      - name: Log in to registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pre-pull image to warm build cache
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/awx_devel:${{ github.base_ref }}

      - name: Build image
        run: |
          DEV_DOCKER_TAG_BASE=ghcr.io/${{ github.repository_owner }} COMPOSE_TAG=${{ github.base_ref }} make docker-compose-build

      - name: Start AWX
        run: |
          DEV_DOCKER_TAG_BASE=ghcr.io/${{ github.repository_owner }} COMPOSE_TAG=${{ github.base_ref }} make docker-compose &> make-docker-compose-output.log &

      - name: Update default AWX password
        run: |
          while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' -k https://localhost:8043/api/v2/ping/)" != "200" ]]
          do
          echo "Waiting for AWX..."
          sleep 5;
          done
          echo "AWX is up, updating the password..."
          docker exec -i tools_awx_1 sh <<-EOSH
            awx-manage update_password --username=admin --password=password
          EOSH

      - name: Run E2E tests
        env:
            CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
        run: |
          cd tower-qa/ui-tests/awx-pf-tests
          AWX_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' tools_awx_1)
          export $AWX_IP
          printenv > .env
          echo "Executing tests:"
          docker run \
          --network '_sources_default' \
          --ipc=host \
          --env-file=.env \
          -e CYPRESS_baseUrl="https://$AWX_IP:8043" \
          -e CYPRESS_AWX_E2E_USERNAME=admin \
          -e CYPRESS_AWX_E2E_PASSWORD='password' \
          -e CYPRESS_RECORD_KEY=$CYPRESS_RECORD_KEY \
          -e COMMAND="npm run cypress-gha" \
          -v /dev/shm:/dev/shm \
          -v $PWD:/e2e \
          -w /e2e \
          awx-pf-tests run --project .


