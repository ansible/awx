---
- name: Find assets
  find:
    paths: "{{ project_path }}/assets"
    file_type: file
    patterns: "{{ item.patterns }}"
    recurse: False
    size: 0
  register: import_files
  loop:
    - name: JSON
      patterns: [ "*.json" ]
    - name: YAML
      patterns: [ "*.yaml", "*.yml" ]
  loop_control:
    label: "{{ item.name }}"

- name: Load assets from json files
  set_fact:
    assets: "{{ assets | default([]) + [ another_asset ] }}"
  loop: "{{ import_files.results[0].files }}"
  loop_control:
     label: "{{ item.path | regex_replace('^.*/assets', 'assets') }}"
  vars:
    another_asset: "{{ lookup('file', item.path) | from_json }}"
  when:
    # This is only an asset we care about if its a job template and belongs to the project we are importing
    - "another_asset.get('natural_key', {}).get('type', '') == 'job_template'"
    - another_assets.get('project', {}).get('name', '') == awx_project

- name: Load job templates tied to the project from yaml files
  set_fact:
    assets: "{{ assets | default([]) + [ another_asset ] }}"
  loop: "{{ import_files.results[1].files }}"
  loop_control:
     label: "{{ item.path | regex_replace('^.*/assets', 'assets') }}"
  vars:
    another_asset: "{{ lookup('file', item.path) | from_yaml }}"
  when:
    # This is only an asset we care about if its a job template and belongs to the project we are importing
    - "another_asset.get('natural_key', {}).get('type', '') == 'job_template'"
    - another_asset.get('project', {}).get('name', '') == awx_project

- name: Import assets
  awx.awx.tower_import:
    assets:
      job_templates:
        - "{{ item }}"
    tower_host: "{{ awx_host }}"
    validate_certs: False
  loop: "{{ assets }}"
  loop_control:
    label: "{{ item.name | default('No Job Template Name')  }}"
