---
- name: Load certs, existing and new SAML settings
  set_fact:
    private_key: "{{ private_key_content }}"
    public_key: "{{ public_key_content }}"
    existing_saml: "{{ lookup('awx.awx.controller_api', 'settings/saml', host=awx_host, username=awx_admin_username, password=awx_admin_password, verify_ssl=false) }}"
    new_saml: "{{ lookup('template', 'saml_settings.json.j2') }}"
    existing_oidc: "{{ lookup('awx.awx.controller_api', 'settings/oidc', host=awx_host, username=awx_admin_username, password=awx_admin_password, verify_ssl=false) }}"
    new_oidc: "{{ lookup('template', 'oidc_settings.json.j2') }}"
  vars:
    # We add the extra \\ in here so that when jinja is templating out the files we end up with \n in the strings.
    public_key_content: "{{ lookup('file', public_key_file) | regex_replace('\n', '\\\\n') }}"
    private_key_content: "{{ lookup('file', private_key_file) | regex_replace('\n', '\\\\n') }}"

- name: Display existing SAML configuration
  debug:
    msg:
      - "Here is your existing SAML configuration for reference:"
      - "{{ existing_saml }}"
      - "Here is your existing OIDC configuration for reference:"
      - "{{ existing_oidc }}"

- name: Write out the existing content
  copy:
    dest: "../_sources/{{ item.filename }}"
    content: "{{ item.content }}"
  loop:
    - filename: "existing_saml_adapter_settings.json"
      content: "{{ existing_saml }}"
    - filename: "existing_oidc_adapter_settings.json"
      content: "{{ existing_oidc }}"
  loop_control:
    label: "{{ item.filename }}"

- name: Configure AWX SAML adapter
  awx.awx.settings:
    settings: "{{ new_saml }}"
    controller_host: "{{ awx_host }}"
    controller_username: "{{ awx_admin_username }}"
    controller_password: "{{ awx_admin_password }}"
    validate_certs: False

- name: Configure AWX OIDC adapter
  awx.awx.settings:
    settings: "{{ new_oidc }}"
    controller_host: "{{ awx_host }}"
    controller_username: "{{ awx_admin_username }}"
    controller_password: "{{ awx_admin_password }}"
    validate_certs: False
